<!DOCTYPE html>
<html lang="es">

<head>
	<title>AVISENA - Restablecer Contraseña</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="Restablece tu contraseña - Plataforma AVISENA">
	<meta name="author" content="ADSO 2925889">
	<link rel="shortcut icon" href="favicon.ico">
	<script defer src="assets/plugins/fontawesome/js/all.min.js"></script>
	<link id="theme-style" rel="stylesheet" href="assets/css/portal.css">
</head>

<body class="app app-reset-password p-0">
	<div class="row g-0 app-auth-wrapper">
		<div class="col-12 col-md-7 col-lg-6 auth-main-col text-center p-5">
			<div class="d-flex flex-column align-content-end">
				<div class="app-auth-body mx-auto">
					<div class="app-auth-branding mb-4">
						<a class="app-logo" href="index.html">
							<img class="logo-icon me-2" src="assets/images/logo-avisena-solo-gallina.png" alt="Logo AVISENA">
						</a>
					</div>
					<h2 class="auth-heading text-center mb-4">Restablecer Contraseña</h2>
					<div class="auth-intro mb-4 text-center">
						Ingresa tu correo electrónico y te enviaremos un código de 6 dígitos para restablecer tu contraseña.
					</div>
					<div class="auth-form-container text-start">
						<form class="auth-form resetpass-form" id="reset-form">
							<div class="email mb-3">
								<label class="sr-only" for="reset-email">Correo electrónico</label>
								<input id="reset-email" name="reset-email" type="email" class="form-control"
									placeholder="Correo electrónico" required>
							</div>
							<div id="reset-message" class="text-center mb-3"></div>
							<div class="text-center">
								<button id="reset-btn" type="submit" class="btn app-btn-primary w-100 theme-btn mx-auto">
									<span id="btn-text">Enviar código</span>
									<span id="btn-spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
								</button>
							</div>
						</form>
						<div class="auth-option text-center pt-5">
							¿Ya la recordaste? <a class="text-link" href="index.html">Inicia sesión</a>
						</div>
					</div>
				</div>
				<footer class="app-auth-footer">
					<div class="container text-center py-3">
						<small class="copyright">Diseñada por ADSO 2925889</small>
					</div>
				</footer>
			</div>
		</div>
		<div class="col-12 col-md-6 col-lg-6 d-none d-md-block position-relative overflow-hidden"
            style="background: url('assets/images/backgrpun-login.png') center/cover;">
            <div class="d-flex flex-column align-items-center justify-content-center h-100 p-4 position-relative">
        	</div>
        </div>
	</div>

	<script>
		const API_URL = 'https://backend-avisena.vercel.app/';

		const form = document.getElementById('reset-form');
		const msg = document.getElementById('reset-message');
		const btnText = document.getElementById('btn-text');
		const btnSpinner = document.getElementById('btn-spinner');
		const btnSubmit = document.getElementById('reset-btn');

		form.addEventListener('submit', async function (e) {
			e.preventDefault();
			
			const email = document.getElementById('reset-email').value;

			msg.className = 'text-center mb-3';
			msg.innerHTML = '';

			btnSubmit.disabled = true;
			btnText.textContent = 'Conectando...';
			btnSpinner.classList.remove('d-none');

			// Mensaje inicial
			msg.innerHTML = `
				<div class="alert alert-info" role="alert">
					<div class="spinner-border spinner-border-sm me-2" role="status"></div>
					<strong>Conectando con el servidor...</strong>
					<br>
					<small>Si es la primera vez, puede tardar hasta 30 segundos.</small>
				</div>
			`;

			try {
				// Timeout de 60 segundos
				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), 60000);

				btnText.textContent = 'Enviando...';

				const response = await fetch(`${API_URL}/access/forgot-password`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Accept': 'application/json'
					},
					body: JSON.stringify({ email: email }),
					signal: controller.signal
				});

				clearTimeout(timeoutId);
				const data = await response.json();

				if (response.ok) {
					msg.innerHTML = `
						<div class="alert alert-success" role="alert">
							<i class="fas fa-check-circle me-2"></i>
							${data.message}
							<br><br>
							<strong>Revisa tu bandeja de entrada y tu carpeta de spam.</strong>
						</div>
					`;
					
					sessionStorage.setItem('reset-email', email);
					
					setTimeout(() => {
						window.location.href = 'confirm-reset-password.html';
					}, 3000);
					
					form.reset();
				} else {
					msg.innerHTML = `
						<div class="alert alert-danger" role="alert">
							<i class="fas fa-exclamation-circle me-2"></i>
							${data.detail || 'Error al procesar la solicitud'}
						</div>
					`;
				}
			} catch (error) {
				if (error.name === 'AbortError') {
					msg.innerHTML = `
						<div class="alert alert-danger" role="alert">
							<i class="fas fa-clock me-2"></i>
							<strong>Tiempo de espera agotado</strong>
							<br>
							El servidor tardó demasiado. Intenta de nuevo.
						</div>
					`;
				} else {
					msg.innerHTML = `
						<div class="alert alert-danger" role="alert">
							<i class="fas fa-times-circle me-2"></i>
							No se pudo conectar con el servidor.
							<br>
							<small class="text-muted">${error.message}</small>
						</div>
					`;
				}
				console.error('Error completo:', error);
			} finally {
				btnSubmit.disabled = false;
				btnText.textContent = 'Enviar código';
				btnSpinner.classList.add('d-none');
			}
		});
		console.log('Verificando conexión con API...');

	</script>
	<script src="./assets/js/main.js"></script>
</body>
</html>
